<!DOCTYPE html>
<html class="h-full bg-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Title</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        html {
            background-color: #f0f0f0;
        }
        @theme {
            --color-main-sky-highlight: #00a3ed;
            --color-main-sky-basic: #9bdcfd;
            --color-main-red-highlight: #ff5353;
            --color-main-red-basic: #ff9898;
            --color-main-yellow-highlight: #fbc159ff;
            --color-main-yellow-basic: #fdd391;
            --color-main-black: #2C2C2C;
        }

        /* PCì—ì„œ ëª¨ë°”ì¼ í¬ê¸°ë¡œ ê³ ì • */
        @media screen and (min-width: 769px) {
            .mobile-container {
                width: 600px;
                margin: 0 auto;
                background: white;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                min-height: 100vh;
            }
        }

        /* ëª¨ë°”ì¼ì—ì„œëŠ” ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
        @media screen and (max-width: 768px) {
            .mobile-container {
                width: 100%;
                background: white;
                min-height: 100vh;
            }
        }
    </style>
</head>

<body>
<div class="flex flex-col w-full mobile-container pt-8 relative bg-white rounded-lg shadow-lg mx-auto">
    <div class="pt-28"><header th:replace="~{header :: header} " class="pt-4"></header></div>

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="px-6">
        <div class="flex items-center mb-6">
            <div class="p-2 mr-3">
                <span class="text-2xl">ğŸ“¢</span>
            </div>
            <h1 class="text-3xl font-bold text-gray-800">ì§€ë‚œ ì•Œë¦¼ ëª©ë¡</h1>
        </div>
    </div>

    <!-- ì•Œë¦¼ ëª©ë¡ -->
    <div class="px-6 pb-8">
        <ul class="space-y-3">
            <li th:each="alarm : ${alarmList}"
                class="flex justify-between items-center bg-white p-4 rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-all duration-300 group">

                <!-- ì¼ë°˜ ê²Œì‹œíŒ ì•Œë¦¼ -->
                <a th:if="${alarm.getCompany_name() == null}"
                   th:href="@{/board/{board_type}/{board_id}(board_type=${alarm.getBoard_type()}, board_id=${alarm.getBoard_id()})}"
                   class="flex items-center flex-1">
                    <span class="flex-shrink-0 bg-blue-50 text-blue-500 rounded-full p-2 mr-3">
                        <span class="alarm-icon text-xl">ğŸ””</span>
                    </span>
                    <span class="text-gray-700" th:text="${alarm.content}"></span>
                </a>

                <!-- ì±„ìš© ìŠ¤í¬ë© ì•Œë¦¼ -->
                <a th:unless="${alarm.getCompany_name() == null}"
                   th:href="@{/job/scrap}"
                   class="flex items-center flex-1">
                    <span class="flex-shrink-0 bg-yellow-50 text-yellow-500 rounded-full p-2 mr-3">
                        <span class="alarm-icon text-xl">ğŸ“Œ</span>
                    </span>
                    <span class="text-gray-700" th:text="${alarm.content}"></span>
                </a>

                <!-- ì‚­ì œ ë²„íŠ¼ - í˜¸ë²„ ì‹œ ë‚˜íƒ€ë‚˜ë„ë¡ -->
                <button class="delete-alarm opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:text-red-700 cursor-pointer ml-2"
                        th:data-alarm-id="${alarm.alarm_id}"
                        th:data-alarm-type="${alarm.alarm_type}"
                        onclick="checkRead(this)">
                    âŒ
                </button>
            </li>

            <!-- ì•Œë¦¼ì´ ì—†ì„ ë•Œ í‘œì‹œí•  ë‚´ìš© -->
            <li th:if="${#lists.isEmpty(alarmList)}" class="text-center py-10">
                <div class="inline-block bg-gray-100 rounded-full p-3 mb-3">
                    <span class="text-2xl">ğŸ”•</span>
                </div>
                <p class="text-gray-600">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </li>
        </ul>
    </div>

    <footer th:replace="~{footer :: footer}" class="pt-4"></footer>
</div>
<body>

<script>
    // ì„œë²„ì˜ SSE ì—”ë“œí¬ì¸íŠ¸ì™€ ì—°ê²°
    const eventSource = new EventSource('http://localhost:8080/subscribe');

    // ì„œë²„ì—ì„œ ì˜¨ "message" ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬
    eventSource.addEventListener('message', function(event) {
        const messageElement = document.createElement('p');
        messageElement.textContent = 'Received: ' + event.data;
        document.body.appendChild(messageElement);
    });

    // ì„œë²„ì—ì„œ ì˜¨ "popular-message" ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬
    eventSource.addEventListener('popular-message', function(event) {
        const messageElement = document.createElement('p');
        messageElement.textContent = 'Received: ' + event.data;
        document.body.appendChild(messageElement);
    });

    // ì„œë²„ì—ì„œ ì˜¨ "scarp-message" ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬
    eventSource.addEventListener('scrap-message', function(event) {
        const messageElement = document.createElement('p');
        messageElement.textContent = 'Received: ' + event.data;
        document.body.appendChild(messageElement);
    });

    // ì—°ê²°ì´ ì—´ë ¸ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
    eventSource.onopen = function() {
        console.log("SSE connection opened");
    };

    // ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
    eventSource.onerror = function(error) {
        console.error("SSE error", error);
        eventSource.close(); // ì˜¤ë¥˜ ì‹œ ì—°ê²°ì„ ë‹«ìŒ
    };

    function checkRead(button) {
        let alarmId = button.getAttribute("data-alarm-id");
        let alarmType = button.getAttribute("data-alarm-type");

        if(button.getAttribute("data-alarm-type") == null) {
            alarmType = "SCRAP";
        }

        console.log(alarmId);

        //ì½ê² ìŠµë‹ˆê¹Œ?
        if (!confirm("ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }

        fetch('/main/alarm/' + alarmId, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({alarm_type: alarmType})
        })
            .then(response => {
                if (response.ok) {
                    button.closest("li").remove(); // ì‚­ì œëœ ì•Œë¦¼ í™”ë©´ì—ì„œ ì œê±°
                } else {
                    alert("ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨!");
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>


</body>