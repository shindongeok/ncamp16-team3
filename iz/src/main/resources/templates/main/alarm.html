<!DOCTYPE html>
<html class="h-full bg-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Izikgram</title>
    <link th:href="@{/images/Logo.png}" rel="shortcut icon" type="image/x-icon">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        @theme {
            --color-main-sky-highlight: #00a3ed;
            --color-main-sky-basic: #9bdcfd;
            --color-main-red-highlight: #ff5353;
            --color-main-red-basic: #ff9898;
            --color-main-yellow-highlight: #fbc159ff;
            --color-main-yellow-basic: #fdd391;
            --color-main-black: #2C2C2C;
        }

        /* ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì‚­ì œ ê¸°ëŠ¥ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .alarm-item {
            position: relative;
            overflow: hidden;
        }

        .alarm-content {
            transform: translateX(0);
            transition: transform 0.3s ease;
            background-color: white;
            position: relative;
            z-index: 1;
        }

        .delete-button {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px;
            background-color: #ef4444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 0;
        }

        /* PCìš© ì‚­ì œ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        @media (min-width: 768px) {
            .alarm-item {
                position: relative;
            }

            .alarm-content {
                position: relative;
            }

            .pc-delete-btn {
                opacity: 0;
                transition: opacity 0.2s ease;
            }

            .alarm-item:hover .pc-delete-btn {
                opacity: 1;
            }
        }
    </style>
    <link rel="stylesheet" th:href="@{/css/default.css}">
</head>

<body>
<div class="flex flex-col w-full min-h-screen mobile-container relative bg-white rounded-lg shadow-lg mx-auto">
    <div class="pt-20"><header th:replace="~{header :: header} " class="pt-4"></header></div>

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="px-6">
        <div class="flex items-center mb-6">
            <div class="p-2 mr-3">
                <span class="text-2xl">ğŸ“¢</span>
            </div>
            <h1 class="text-[1.7em] md:text-[1.7em] font-bold text-[#2C2C2C]">ì§€ë‚œ ì•Œë¦¼ ëª©ë¡</h1>
        </div>
    </div>

    <!-- ì•Œë¦¼ ëª©ë¡ -->
    <div class="px-6 pb-8">
        <ul class="space-y-3">
            <li th:each="alarm : ${alarmList}"
                class="alarm-item relative overflow-hidden rounded-lg border border-gray-100 shadow-sm">

                <!-- ì‚­ì œ ë²„íŠ¼ (ëª¨ë°”ì¼ìš©) - ìŠ¤ì™€ì´í”„ ì‹œ ë…¸ì¶œë¨ -->
                <div class="delete-button md:hidden"
                     th:data-alarm-id="${alarm.alarm_id}"
                     th:data-alarm-type="${alarm.alarm_type}"
                     onclick="checkRead(this)">
                    ì‚­ì œ
                </div>

                <!-- ì•Œë¦¼ ë‚´ìš© ì»¨í…Œì´ë„ˆ -->
                <div class="alarm-content flex justify-between items-center bg-white p-4">
                    <!-- ì¼ë°˜ ê²Œì‹œíŒ ì•Œë¦¼ -->
                    <a th:if="${alarm.getCompany_name() == null}"
                       th:href="@{/board/{board_type}/{board_id}(board_type=${alarm.getBoard_type()}, board_id=${alarm.getBoard_id()})}"
                       class="flex items-center flex-1">
                        <span class="flex-shrink-0 bg-blue-50 text-blue-500 rounded-full p-2 mr-3">
                            <span class="alarm-icon text-xl">ğŸ””</span>
                        </span>
                        <span class="text-gray-700" th:text="${alarm.content}"></span>
                    </a>

                    <!-- ì±„ìš© ìŠ¤í¬ë© ì•Œë¦¼ -->
                    <a th:unless="${alarm.getCompany_name() == null}"
                       th:href="@{${alarm.getUrl()}}"
                       class="flex items-center flex-1">
                        <span class="flex-shrink-0 bg-yellow-50 text-yellow-500 rounded-full p-2 mr-3">
                            <span class="alarm-icon text-xl">ğŸ“Œ</span>
                        </span>
                        <span class="text-gray-700" th:text="${alarm.content}"></span>
                    </a>

                    <!-- pcìš© ì‚­ì œ ë²„íŠ¼ - í˜¸ë²„ ì‹œ ë‚˜íƒ€ë‚˜ë„ë¡ -->
                    <button class="pc-delete-btn hidden md:block text-red-500 hover:text-red-700 cursor-pointer ml-2"
                            th:data-alarm-id="${alarm.alarm_id}"
                            th:data-alarm-type="${alarm.alarm_type}"
                            onclick="checkRead(this)">
                        âŒ
                    </button>
                </div>
            </li>

            <!-- ì•Œë¦¼ì´ ì—†ì„ ë•Œ í‘œì‹œí•  ë‚´ìš© -->
            <li th:if="${#lists.isEmpty(alarmList)}" class="text-center py-10">
                <div class="inline-block bg-gray-100 rounded-full p-3 mb-3">
                    <span class="text-2xl">ğŸ”•</span>
                </div>
                <p class="text-gray-600">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </li>
        </ul>
    </div>

    <!-- ì•Œë¦¼ ì‚­ì œ ëª¨ë‹¬ -->
    <div id="alarmDeleteModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>

        <div class="fixed inset-0 z-10 w-screen overflow-y-auto flex items-center justify-center p-4 sm:items-center sm:p-0">
            <div class="flex min-h-full items-center justify-center p-4 w-full max-w-md text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all w-11/12 max-w-xs sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex size-12 shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:size-10">
                                <svg class="size-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-base font-semibold text-gray-900" id="alarm-modal-title">ì•Œë¦¼ ì‚­ì œ</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500">ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button id="confirmDeleteAlarm" type="button"
                                class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-red-500 sm:ml-3 sm:w-auto">
                            ì‚­ì œí•˜ê¸°
                        </button>
                        <button onclick="closeAlarmModal()" type="button"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 shadow-xs ring-gray-300 ring-inset hover:bg-gray-50 sm:mt-0 sm:w-auto">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{footer :: footer}" class="pt-4"></footer>
</div>

<script>
    function connectSSE() {
        // ì„œë²„ì˜ SSE ì—”ë“œí¬ì¸íŠ¸ì™€ ì—°ê²°
        const baseUrl = window.location.hostname === 'localhost' ?
            'http://localhost:8080' : // ë¡œì»¬ìš©
            'http://223.130.151.184:8080'; // ì„œë²„ìš©

        const eventSource = new EventSource(`${baseUrl}/subscribe`);


        // ì„œë²„ì—ì„œ "subscribe" ì´ë²¤íŠ¸ ì²˜ë¦¬ (SSE ì—°ê²° í™•ì¸ ìš©ë„)
        eventSource.addEventListener('subscribe', function(event) {
            console.log("SSE êµ¬ë… ì„±ê³µ:", event.data);
        });

        // ì„œë²„ì—ì„œ ì˜¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤...
        eventSource.addEventListener('message', function(event) {
            const messageElement = document.createElement('p');
            messageElement.textContent = 'Received: ' + event.data;
            document.body.appendChild(messageElement);
        });

        eventSource.addEventListener('popular-message', function(event) {
            const messageElement = document.createElement('p');
            messageElement.textContent = 'Received: ' + event.data;
            document.body.appendChild(messageElement);
        });

        eventSource.addEventListener('scrap-message', function(event) {
            const messageElement = document.createElement('p');
            messageElement.textContent = 'Received: ' + event.data;
            document.body.appendChild(messageElement);
        });

        eventSource.onopen = function() {
            console.log("SSE ì—°ê²° ì„±ê³µ");
        };

        eventSource.onerror = function(error) {
            console.error("SSE ì—°ê²° ëŠê¹€", error);

            // ì—°ê²°ì´ ë‹«í˜”ëŠ”ì§€ í™•ì¸ í›„ ì¬ì—°ê²°
            if (eventSource.readyState === EventSource.CLOSED) {
                console.log("3ì´ˆ í›„ SSE ì¬ì—°ê²° ì‹œë„...");
                eventSource.close(); // ì˜¤ë¥˜ ì‹œ ì—°ê²°ì„ ë‹«ìŒ
                setTimeout(connectSSE, 3000); // 3ì´ˆ í›„ ì¬ì—°ê²°
            }
        };
    }

    connectSSE();

    // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì•Œë¦¼ ì •ë³´ ì €ì¥
    let currentAlarmId = null;
    let currentAlarmType = null;
    let currentAlarmElement = null;

    // ì•Œë¦¼ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function checkRead(button) {
        // ì•Œë¦¼ ì •ë³´ ì €ì¥
        currentAlarmId = button.getAttribute("data-alarm-id");
        currentAlarmType = button.getAttribute("data-alarm-type") || "SCRAP";
        currentAlarmElement = button.closest('.alarm-item') || button.parentNode.closest('.alarm-item');

        console.log("ì„ íƒëœ ì•Œë¦¼ ID:", currentAlarmId);

        // ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('alarmDeleteModal').classList.remove('hidden');
    }

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeAlarmModal() {
        document.getElementById('alarmDeleteModal').classList.add('hidden');
        // ë³€ìˆ˜ ì´ˆê¸°í™”
        currentAlarmId = null;
        currentAlarmType = null;
        currentAlarmElement = null;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚­ì œ í™•ì¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', function() {
        // íšŒì› íƒˆí‡´ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
        window.closeModal = function() {
            document.getElementById('deleteModal').classList.add('hidden');
        };

        // ì•Œë¦¼ ì‚­ì œ í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('confirmDeleteAlarm').addEventListener('click', function() {
            if (currentAlarmId) {
                fetch('/main/alarm/' + currentAlarmId, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({alarm_type: currentAlarmType})
                })
                    .then(response => {
                        if (response.ok) {
                            if (currentAlarmElement) {
                                currentAlarmElement.remove(); // ì‚­ì œëœ ì•Œë¦¼ í™”ë©´ì—ì„œ ì œê±°
                            }
                            updateAlarmCount(); // ì•Œë¦¼ ê°œìˆ˜ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                            closeAlarmModal(); // ëª¨ë‹¬ ë‹«ê¸°
                        } else {
                            alert("ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨!");
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    });
            }
        });

        // ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAlarmCount() {
            fetch('/main/alarm/count')  // ìµœì‹  ì•Œë¦¼ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
                .then(response => response.json()) // count : {count=1}
                .then(data => {
                    let headerAlarmCount = document.getElementById('alarmCount'); // í—¤ë”ì— ìˆëŠ” ì•Œë¦¼ ê°œìˆ˜ idê°’
                    if (headerAlarmCount && data.count !== undefined) {
                        // ì•Œë¦¼ ê°œìˆ˜ê°€ 0ë³´ë‹¤ í´ ë•Œë§Œ í‘œì‹œ
                        if (data.count > 0) {
                            headerAlarmCount.innerText = data.count; // ìµœì‹  ê°œìˆ˜ë¡œ ì—…ë°ì´íŠ¸
                            headerAlarmCount.style.display = 'inline-flex'; // ê°œìˆ˜ í‘œì‹œ
                        } else {
                            headerAlarmCount.style.display = 'none'; // ì•Œë¦¼ ì˜¨ ê²Œ ì—†ìœ¼ë©´ ìˆ¨ê¹€
                        }
                    }
                })
                .catch(error => console.error('Error updating alarm count:', error));
        }

    });

    // ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ êµ¬í˜„
    document.addEventListener('DOMContentLoaded', function() {
        const alarmItems = document.querySelectorAll('.alarm-item');

        alarmItems.forEach(item => {
            const content = item.querySelector('.alarm-content');
            let startX, moveX;
            let isSwiped = false;

            // í„°ì¹˜ ì‹œì‘ ì´ë²¤íŠ¸
            content.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                content.style.transition = '';
            });

            // í„°ì¹˜ ì´ë™ ì´ë²¤íŠ¸
            content.addEventListener('touchmove', function(e) {
                moveX = e.touches[0].clientX;
                const diff = moveX - startX;

                // ì™¼ìª½ìœ¼ë¡œë§Œ ìŠ¤ì™€ì´í”„ ê°€ëŠ¥
                if (diff < 0) {
                    // ìµœëŒ€ -80pxê¹Œì§€ë§Œ ì´ë™ ê°€ëŠ¥
                    const x = Math.max(diff, -80);
                    content.style.transform = `translateX(${x}px)`;
                }
            });

            // í„°ì¹˜ ì¢…ë£Œ ì´ë²¤íŠ¸
            content.addEventListener('touchend', function() {
                content.style.transition = 'transform 0.3s ease';

                // ì¶©ë¶„íˆ ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ í–ˆìœ¼ë©´ ì‚­ì œ ë²„íŠ¼ ë…¸ì¶œ
                if (startX - moveX > 40) {
                    content.style.transform = 'translateX(-80px)';
                    isSwiped = true;
                } else {
                    content.style.transform = 'translateX(0)';
                    isSwiped = false;
                }
            });

            // í™”ë©´ ì „ì²´ í„°ì¹˜ ì´ë²¤íŠ¸ (ìŠ¤ì™€ì´í”„ëœ í•­ëª© ë‹«ê¸°)
            document.addEventListener('touchstart', function(e) {
                const alarmContents = document.querySelectorAll('.alarm-content');
                alarmContents.forEach(contentElement => {
                    // í˜„ì¬ í„°ì¹˜í•œ ìš”ì†Œê°€ ì´ ì½˜í…ì¸ ë‚˜ ê·¸ ìì‹ì´ ì•„ë‹ˆë©´ ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›
                    if (isSwiped && !contentElement.contains(e.target) && contentElement !== content) {
                        contentElement.style.transition = 'transform 0.3s ease';
                        contentElement.style.transform = 'translateX(0)';
                        isSwiped = false;
                    }
                });
            });
        });
    });
</script>

</body>
</html>