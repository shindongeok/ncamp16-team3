<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Izikgram</title>
    <link th:href="@{/images/Logo.png}" rel="shortcut icon" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/default.css}">
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
<div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg relative">
    <div class="pt-20"><header th:replace="~{header :: header} " class="pt-4"></header></div>

    <!-- í™˜ì˜ ë©”ì‹œì§€ -->
    <div class="mb-6 ">

        ì•ˆë…•í•˜ì„¸ìš”, <span th:text="${#authentication.getPrincipal().getUser().getNickname()}"></span>ë‹˜!
        <p class="text-sm text-gray-600">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</p>
    </div>

    <!-- ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
    <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="stresschat()" class="p-3 text-sm text-left bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
            ì˜¤ëŠ˜ì˜ í‡´ì‚¬ ìˆ˜ì¹˜
        </button>

        <button onclick="feelchat()" class="p-3 text-sm text-left bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
            í•˜ì†Œì—°í•˜ê¸°
        </button>

        <button onclick="paydaychat()" class="p-3 text-sm text-left bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
            ì›”ê¸‰ì¼ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜
        </button>

        <button onclick="endtimechat()" class="p-3 text-sm text-left bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
            ë‚¨ì€ í‡´ê·¼ì‹œê°„
        </button>

        <button onclick="handleJobPostings()" class="p-3 text-sm text-left bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
            ë§ì¶¤í˜• ì´ì§ ê³µê³  ë³´ê¸°
        </button>
    </div>

    <!-- ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="messages" class="max-h-96 overflow-y-auto mb-4 p-4 border border-gray-300 rounded-lg space-y-3">
        <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>

    <!-- ì‚¬ìš©ì ì…ë ¥ ì˜ì—­ -->
    <div class="flex">
        <input id="userInput" type="text" class="w-full p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="checkEnter(event)">
        <button onclick="handleGeneralChat()" class=" bg-blue-500 text-white p-2 rounded-r-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">ì „ì†¡</button>
    </div>
</div>
<!-- Thymeleafë¡œ ì‚¬ìš©ì ì›”ê¸‰ë‚  ì£¼ì… -->
<div id="paydayData" th:data-payday="${#authentication.getPrincipal().getUser().getPayday()}"></div>
<div id="endtimeData" th:data-endtime="${#authentication.getPrincipal().getUser().getEnd_time()}"></div>
<div id="stressData" th:data-stress="${@mainService.getStressNum(#authentication.principal.user.member_id)}"></div>

<script>
    // ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function appendUserMessage(text) {
        const messagesDiv = document.getElementById('messages');
        const userMessageDiv = document.createElement('div');
        userMessageDiv.classList.add('text-right', 'text-sm', 'bg-blue-100', 'rounded-lg', 'p-2');
        userMessageDiv.innerText = text;
        messagesDiv.appendChild(userMessageDiv);
        return messagesDiv;
    }

    function appendBotMessage(text) {
        const messagesDiv = document.getElementById('messages');
        const botMessageDiv = document.createElement('div');
        botMessageDiv.classList.add('text-left', 'text-sm', 'bg-gray-100', 'rounded-lg', 'p-2');
        botMessageDiv.innerText = text;
        messagesDiv.appendChild(botMessageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showLoading(message = 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...') {
        const messagesDiv = document.getElementById('messages');
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingMessage';
        loadingDiv.classList.add('text-center', 'text-sm', 'text-gray-500');
        loadingDiv.innerText = message;
        messagesDiv.appendChild(loadingDiv);
    }

    function removeLoading() {
        const loadingMessage = document.getElementById('loadingMessage');
        if (loadingMessage) loadingMessage.remove();
    }

    // ê° ë²„íŠ¼ë³„ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤
    async function paydaychat() {
        appendUserMessage("ì›”ê¸‰ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜?");
        showLoading("ê¸‰ì—¬ì¼ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...");

        // Thymeleafë¥¼ í†µí•´ HTMLì— ì£¼ì…ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const paydayStr = document.getElementById('paydayData').getAttribute('data-payday');

        if (!paydayStr) {
            removeLoading();
            appendBotMessage("ê¸‰ì—¬ì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ
        const today = new Date();
        const payday = new Date(today.getFullYear(), today.getMonth(), parseInt(paydayStr));

        // ì›”ê¸‰ë‚ ì´ ì´ë¯¸ ì§€ë‚¬ìœ¼ë©´ ë‹¤ìŒ ë‹¬ë¡œ ë³€ê²½
        if (payday < today) {
            payday.setMonth(payday.getMonth() + 1);
        }

        // D-DAY ê³„ì‚°
        setTimeout(() => {
            const timeDiff = payday - today;
            const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

            // ë¡œë”© ë©”ì‹œì§€ ì œê±° í›„ ì±—ë´‡ ì‘ë‹µ ì¶”ê°€
            removeLoading();
            appendBotMessage(`ì›”ê¸‰ì¼ê¹Œì§€ ${daysLeft}ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`);
        }, 500);
    }

    async function endtimechat() {
        appendUserMessage("ë‚¨ì€ í‡´ê·¼ì‹œê°„");
        showLoading("í‡´ê·¼ì‹œê°„ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...");

        setTimeout(() => {
            const endtimeElement = document.getElementById('endtimeData');
            const endtimeStr = endtimeElement.getAttribute('data-endtime'); // "2025-02-21 18:00" ê°™ì€ í˜•íƒœ

            if (!endtimeStr) {
                appendBotMessage("í‡´ê·¼ì‹œê°„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const today = new Date();
            const [endHour, endMinute] = endtimeStr.split(":").map(Number);
            const endtime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, endMinute);

            const diffTime = endtime - today;

            if (diffTime <= 0) {
                removeLoading();
                appendBotMessage("í‡´ê·¼ ì‹œê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤!");
                return;
            }

            const diffHours = Math.floor(diffTime / (1000 * 60 * 60)); // ë‚¨ì€ ì‹œê°„
            const diffMinutes = Math.floor((diffTime % (1000 * 60 * 60)) / (1000 * 60)); // ë‚¨ì€ ë¶„

            removeLoading();
            appendBotMessage(`í‡´ê·¼ê¹Œì§€ ${diffHours}ì‹œê°„ ${diffMinutes}ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`);
        }, 500); // 1ì´ˆ ëŒ€ê¸° í›„ ì²˜ë¦¬
    }

    async function stresschat() {
        const messagesDiv = appendUserMessage("ì˜¤ëŠ˜ì˜ í‡´ì‚¬ ìˆ˜ì¹˜");
        showLoading('í‡´ì‚¬ í†µê³„ë¥¼ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤...');

        // 500ms í›„ì— stress ìˆ˜ì¹˜ ê°€ì ¸ì˜¤ê¸°
        setTimeout(() => {
            const stressStr = document.getElementById('stressData').getAttribute('data-stress');

            console.log(stressStr);  // ìŠ¤íŠ¸ë ˆìŠ¤ ê°’ì´ ì˜ ë‚˜ì˜¤ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì½˜ì†”ì— ì¶œë ¥

            if (!stressStr) {
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í•´ë‹¹ ë©”ì‹œì§€ ì¶œë ¥
                removeLoading();
                appendBotMessage("í‡´ì‚¬ ì§€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‡´ì‚¬ ì§€ìˆ˜ ì¶œë ¥
            removeLoading();
            appendBotMessage(`ì˜¤ëŠ˜ì˜ í‡´ì‚¬ì§€ìˆ˜ëŠ” ${stressStr}% ì…ë‹ˆë‹¤.`);
        }, 500);
    }

    async function feelchat() {  //í•˜ì†Œì—°í•˜ê¸°
        const messagesDiv = appendUserMessage("í•˜ì†Œì—°í•˜ê¸°");
        showLoading('ì—°ê²°ì¤‘ì…ë‹ˆë‹¤...');

        try {
            const response = await fetch('/api/test-records');
            const data = await response.json();
            removeLoading();
            appendBotMessage(data.record);
        } catch (error) {
            removeLoading();
            appendBotMessage('ê°ì • ê¸°ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì¼ë°˜ ì±„íŒ… í•¸ë“¤ëŸ¬
    async function handleGeneralChat() {
        const userInput = document.getElementById('userInput');
        const message = userInput.value.trim();

        if (!message) return;

        const messagesDiv = appendUserMessage(message);
        showLoading('ë‹µë³€ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...');

        try {
            const response = await fetch('/chat/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: message }]
                })
            });

            const data = await response.json();
            removeLoading();
            appendBotMessage(data.response);
        } catch (error) {
            removeLoading();
            appendBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        userInput.value = '';
    }

    function formatTimestamp(timestamp) {
        const date = new Date(timestamp * 1000); // Unix timestampë¥¼ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ë§ì¶¤í˜• ì´ì§ ê³µê³  í•¸ë“¤ëŸ¬
    async function handleJobPostings() {
        appendUserMessage("ë§ì¶¤í˜• ì´ì§ ê³µê³ ");
        showLoading("ë§ì¶¤í˜• ì±„ìš©ê³µê³ ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...");

        try {
            const response = await fetch('/user/analyze/recommend-jobs', {
                method: 'POST'
            });

            const recommendedJobs = await response.json();

            removeLoading();

            if (recommendedJobs.length === 0) {
                appendBotMessage("í˜„ì¬ ë§ì¶¤í˜• ì±„ìš©ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ë§ì¶¤í˜• ê³µê³  ë©”ì‹œì§€ ìƒì„±
            recommendedJobs.forEach(job => {
                const jobMessage = `ğŸŒŸ ì¶”ì²œ ì±„ìš©ê³µê³ 

ğŸ“ ê¸°ì—…ëª…: ${job.companyName}
ğŸ“‹ ì œëª©: ${job.title}
ğŸ“ ì§€ì—­: ${job.locationName}
ğŸ’¼ ì—…ì¢…: ${job.industryName}
ğŸ‘¥ ê²½ë ¥: ${job.experienceMax === 0 && job.experienceMin === 0 ? 'ì‹ ì…'
                    : (job.experienceMax === job.experienceMin ? `ê²½ë ¥ ${job.experienceMax}ë…„`
                        : `ê²½ë ¥ ${Math.min(job.experienceMax, job.experienceMin)}~${Math.max(job.experienceMax, job.experienceMin)}ë…„`)}
ğŸ“… ë§ˆê°ì¼: ${formatTimestamp(parseFloat(job.expirationTimestamp))}`;

                // HTML ë§í¬ë¥¼ í¬í•¨í•œ ë©”ì‹œì§€ ìƒì„±
                const linkMessage = `${jobMessage}\n\nğŸ‘‰ <a href="${job.url}" target="_blank" style="color: blue; text-decoration: underline;">ìƒì„¸ í˜ì´ì§€ ë°”ë¡œê°€ê¸°</a>`;

                appendBotMessage(linkMessage);
            });

        } catch (error) {
            removeLoading();
            appendBotMessage('ë§ì¶¤í˜• ì±„ìš©ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error('Error fetching recommended jobs:', error);
        }
    }

    function appendBotMessage(text) {
        const messagesDiv = document.getElementById('messages');
        const botMessageDiv = document.createElement('div');
        botMessageDiv.classList.add('text-left', 'text-sm', 'bg-gray-100', 'rounded-lg', 'p-2');

        // HTMLì„ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•˜ì—¬ ì¶”ê°€
        botMessageDiv.innerHTML = text.replace(/\n/g, '<br>');

        messagesDiv.appendChild(botMessageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Enter í‚¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function checkEnter(event) {
        if (event.key === 'Enter') {
            handleGeneralChat();
        }
    }
    const stressNum = /*[[${@mainService.getStressNum(#authentication.principal.user.member_id)}]]*/ 0;

</script>
</body>
</html>